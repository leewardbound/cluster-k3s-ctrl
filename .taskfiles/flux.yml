---
version: "3"

tasks:
  sync:
    desc: Sync flux-system with the Git Repository
    cmds:
      - flux reconcile source git flux-system
    silent: true

  initialize:
    desc: Initialize Flux Base (may have errors due to CRD race conditions, but should re-attempt once)
    cmds:
      - flux check --pre
      - kubectl apply --kustomize=./cluster/base/flux-system || kubectl apply --kustomize=./cluster/base/flux-system
      - cat $SOPS_AGE_KEY_FILE | kubectl -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin
